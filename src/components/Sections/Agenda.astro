---
import BreakItem from "@components/AgendaItem/BreakItem.astro";
import SponsorItem from "@components/AgendaItem/SponsorItem.astro";
import TalkItem from "@components/AgendaItem/TalkItem.astro";
import type { CollectionEntry } from "astro:content";
import dayjs from "dayjs";

interface Props {
  talks: CollectionEntry<"talks">[];
}

type Talk = CollectionEntry<"talks">["data"][0];

const { talks } = Astro.props;

const sortByDate = (a: Talk, b: Talk) => {
  const aDate = new Date(a.startDate);
  const bDate = new Date(b.startDate);

  return aDate.getTime() - bDate.getTime();
};

const DAY = "devfest";
const tracksData: Record<string, any> = {
  track1: {
    name: "Xepia",
    date: "2025-11-07",
  },
  track2: {
    name: "Torreón",
    date: "2025-11-08",
  },
};

// Build a time slot grid: each row is a time slot, each column is a track
const trackSchedule = talks
  .find((talk) => talk.id === DAY)
  ?.data.sort(sortByDate);

// Get all unique start times, sorted
const allTimes = Array.from(
  new Set(trackSchedule?.map((talk) => talk.startDate))
).sort((a, b) => new Date(a).getTime() - new Date(b).getTime());

const trackKeys = Array.from(
  new Set(
    trackSchedule?.flatMap((talk) =>
      Array.isArray(talk.track) ? talk.track.map(String) : []
    ) ?? []
  )
);

// Build a grid: rows = time slots, columns = tracks
const agendaGrid = allTimes.map((time) => {
  const row = trackKeys.map((track) =>
    trackSchedule?.find((talk) => {
      const talkTracks = Array.isArray(talk.track)
        ? talk.track.map(String)
        : [];
      return talk.startDate === time && talkTracks.includes(track);
    })
  );
  return { time, row };
});
---

<section class="my-8">
  <div class="footer-bg top">
    <svg
      viewBox="0 0 500 20"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      class="w-full h-auto"
      preserveAspectRatio="none"
      style="transform: rotate(180deg);"
    >
      <polygon points="0,0 500,20 500,0 0,0" fill="var(--agenda-bg)"></polygon>
    </svg>
  </div>
  <div class="content flex items-center justify-center flex-col px-2">
    <h3 class="text-2xl font-bold py-2 md:text-5xl md:mb-12">Cronograma</h3>
    <span class="text-md md:text-lg font-light mb-6 md:mb-12"
      >Lugar: Universidad Autónoma de Occidente Cali.</span
    >

    <div
      class="agenda-grid"
      style={`display: grid; grid-template-columns: repeat(${trackKeys.length}, 1fr); align-items: stretch;`}
    >
      {/* Header row */}
      {
        trackKeys.map((track) => (
          <div class="px-4 py-8 flex flex-col items-center justify-center">
            <h3 class="text-3xl font-bold text-center m-0 text-black">
              {tracksData[track].name}
            </h3>
            <h4 class="text-xl font-normal text-center text-black">
              {dayjs(tracksData[track].date).format("MMMM D")}
            </h4>
          </div>
        ))
      }
      {/* Agenda rows */}
      {
        agendaGrid.map(({ time, row }) =>
          row.map((talk, idx) => (
            <div class="agenda-cell min-h-[60px] flex flex-col justify-stretch">
              {talk && (
                <>
                  {(() => {
                    switch (talk.type) {
                      case "talk":
                        return <TalkItem talk={talk} />;
                      case "sponsor":
                        return <SponsorItem talk={talk} />;
                      case "break":
                        return <BreakItem talk={talk} />;
                      default:
                        return <div />;
                    }
                  })()}
                </>
              )}
            </div>
          ))
        )
      }
    </div>
  </div>
  <div class="footer-bg bottom fixed">
    <svg
      viewBox="0 0 500 20"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      class="w-full h-auto"
      preserveAspectRatio="none"
    >
      {/* Declination from left (top) to right (bottom) */}
      <polygon points="0,0 500,20 500,0 0,0" fill="var(--agenda-bg)"></polygon>
    </svg>
  </div>
</section>

<style>
  :root {
    --agenda-bg: #8ed8f8;
  }
  .content {
    background-color: var(--agenda-bg);
  }

  .footer-bg {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  .footer-section {
    position: relative;
    padding-top: 0;
    margin-top: 0;
  }

  .footer-section .top {
    border-bottom: 1px solid var(--agenda-bg);
  }

  .footer-section .bottom {
    /* background-color: #003773; */
  }
  .agenda-grid {
    background-color: var(--agenda-bg);
    width: 100%;
    border-radius: 0 0 8px 8px;
    overflow: hidden;
  }
  .agenda-cell {
    box-sizing: border-box;
  }
</style>
